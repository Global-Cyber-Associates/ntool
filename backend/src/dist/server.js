var ae=Object.defineProperty;var w=(t,n)=>()=>(t&&(n=t(t=0)),n);var ie=(t,n)=>{for(var e in n)ae(t,e,{get:n[e],enumerable:!0})};import g from"mongoose";var de,me,le,ue,ge,d,f=w(()=>{de=new g.Schema({physical_cores:Number,logical_cores:Number,cpu_freq_mhz:Number}),me=new g.Schema({total_ram:Number,available_ram:Number,used_ram:Number,ram_percent:Number}),le=new g.Schema({mountpoint:String,fstype:String,total:Number,used:Number,free:Number,percent:Number}),ue=new g.Schema({interface_name:String,type:String,address:String,netmask:String,broadcast:String}),ge=new g.Schema({agentId:{type:String,required:!0,index:!0,ref:"Agent"},timestamp:{type:String,required:!0},type:{type:String,default:"system_info"},data:{agent_id:String,hostname:String,os_type:String,os_version:String,os_release:String,cpu:de,memory:me,disk:{type:Map,of:le},users:[String],machine_id:String,wlan_info:[ue],ip:String}}),d=g.model("SystemInfo",ge)});import E from"mongoose";var L,ve,l,$=w(()=>{L=new E.Schema({agentId:{type:String,required:!0,index:!0,ref:"Agent"},ip:{type:String,required:!0},mac:{type:String,required:!0},vendor:String,hostname:{type:String,default:"Unknown"},noAgent:{type:Boolean,default:!1},createdAt:{type:Date,default:Date.now}});L.index({ip:1});ve=E.model("VisualizerData",L),l=ve});import Q from"mongoose";var X,S,j=w(()=>{X=new Q.Schema({agentId:{type:String,required:!0,index:!0,ref:"Agent"},mac:{type:String,default:null},ips:[{type:String}],vendor:{type:String,default:"Unknown"},mobile:{type:Boolean,default:!1},ping_only:{type:Boolean,default:!1},lastSeen:{type:Date,default:Date.now}});X.index({"ips.0":1});S=Q.model("VisualizerScanner",X)});var ee={};ie(ee,{runVisualizerUpdate:()=>Pe});import Ue from"mongoose";import ke from"fs";import Z from"path";import{fileURLToPath as Ne}from"url";async function qe(){Y||(await Ue.connect(Fe,{useNewUrlParser:!0,useUnifiedTopology:!0}),Y=!0,console.log("\u2705 MongoDB connected for visualizer update"))}async function Pe(){try{await qe();let t=await S.find({}).sort({createdAt:-1});if(!t.length){console.log("\u26A0\uFE0F No scan results found.");return}let n=await d.find(),e=new Map,o=new Map,r=new Set;n.forEach(a=>{let i=a.data?.wlan_info||a.wlan_ip||[],p=a.data?.hostname||a.hostname||"Unknown",x=a?.agent_id||a.agentId||"unknown";i.forEach(F=>{let y=(F.address||"").trim();y&&(r.add(y),e.set(y,p),o.set(y,x))})});let s=t.filter(a=>a.isAlive===!0||a.ping_only===!0||a.status==="alive"||a.pingSuccess===!0);if(!s.length){console.log("\u26A0\uFE0F No active devices detected \u2014 nothing updated.");return}let c=s.map(a=>{let i=(a.ips?.[0]||"N/A").trim(),p=r.has(i),x=p&&e.get(i)||"Unknown";return{agentId:p&&o.get(i)||"unknown",ip:i,mac:a.mac||"Unknown",vendor:a.vendor||"Unknown",hostname:x,noAgent:!p,createdAt:new Date}});await l.deleteMany({}),await l.insertMany(c),console.log(`[${new Date().toLocaleTimeString()}] \u2705 Visualizer updated \u2014 ${c.length} active devices stored`)}catch(t){console.error(`[${new Date().toLocaleTimeString()}] \u274C Visualizer update failed:`,t.message)}}var je,Me,Oe,Be,Fe,Y,te=w(()=>{j();f();$();je=Ne(import.meta.url),Me=Z.dirname(je),Oe=Z.resolve(Me,"../config.json"),Be=JSON.parse(ke.readFileSync(Oe,"utf-8")),Fe=Be.mongo_uri,Y=!1});import oe from"express";import Ke from"http";import Qe from"cors";import A from"fs";import re from"path";import{Server as Xe}from"socket.io";import q from"mongoose";async function P(t,n={}){if(!t)throw new Error("MongoDB URI is required");let e={useNewUrlParser:!0,useUnifiedTopology:!0,serverSelectionTimeoutMS:1e4,...n};try{return await q.connect(t,e),console.log("\u2705 MongoDB connected"),q.connection}catch(o){throw console.error("\u274C MongoDB connection error:",o.message||o),o}}import z from"mongoose";var ce=new z.Schema({agentId:{type:String,required:!0,unique:!0},socketId:{type:String},ip:{type:String},lastSeen:{type:Date,default:Date.now}}),_=z.model("Agent",ce);f();import U from"mongoose";var pe=new U.Schema({name:String,version:String,publisher:String,install_date:String,install_location:String,uninstall_string:String,display_icon:String,registry_key:String}),fe=new U.Schema({agentId:{type:String,required:!0,index:!0,ref:"Agent"},timestamp:{type:String,required:!0},type:{type:String,default:"installed_apps"},data:{apps:[pe],count:Number}}),v=U.model("InstalledApps",fe);import R from"mongoose";var Se=new R.Schema({agentId:{type:String,required:!0,index:!0,ref:"Agent"},timestamp:{type:String,required:!0},type:{type:String,default:"port_scan"},data:{target:String,open_ports:[Number],scanned_range:String}}),b=R.model("PortScan",Se);import D from"mongoose";var he=new D.Schema({pid:Number,name:String,title:String,cpu_percent:Number,memory_percent:Number}),ye=new D.Schema({pid:Number,name:String,cpu_percent:Number,memory_percent:Number}),we=new D.Schema({agentId:{type:String,required:!0,index:!0,ref:"Agent"},timestamp:{type:String,required:!0},type:{type:String,default:"task_info"},data:{applications:[he],background_processes:[ye]}}),I=D.model("TaskInfo",we);async function T(t){try{if(!t||!t.type||!t.data||!t.agentId){console.error("\u274C Invalid payload: missing type, data, or agentId");return}let{type:n,agentId:e,data:o}=t,r=t.timestamp||new Date().toISOString();try{await _.findOneAndUpdate({agentId:e},{$set:{agentId:e,socketId:t.socket_id||null,ip:t.ip||"unknown",lastSeen:new Date}},{upsert:!0,new:!0}),console.log(`\u{1F4BE} Agent [${e}] saved/updated`)}catch(a){console.error(`\u274C Failed to upsert Agent [${e}]:`,a);return}if(n==="usb_devices"){console.log("\u2139\uFE0F USB data is handled separately. Skipping save here.");return}let s;switch(n){case"system_info":s=d;break;case"installed_apps":s=v;break;case"port_scan":s=b;break;case"task_info":s=I;break;default:console.warn(`\u26A0\uFE0F Unknown data type: ${n}. Ignoring.`);return}let c={agentId:e,timestamp:r,type:n,data:o};try{await s.findOneAndUpdate({agentId:e},{$set:c},{upsert:!0,new:!0}),console.log(`\u2705 [${n}] saved for agent ${e}`)}catch(a){console.error(`\u274C Failed to save [${n}] for agent ${e}:`,a)}}catch(n){console.error("\u274C Failed to save agent data:",n)}}f();import V from"mongoose";var _e=new V.Schema({agentId:{type:String,required:!0,unique:!0},data:{connected_devices:[{drive_letter:{type:String,default:""},vendor_id:{type:String,default:""},product_id:{type:String,default:""},description:{type:String,default:""},serial_number:{type:String,required:!0},status:{type:String,enum:["Allowed","Blocked","WaitingForApproval"],default:"WaitingForApproval"},last_seen:{type:Date,default:Date.now}}]}},{timestamps:!0}),m=V.model("USBDevices",_e);$();async function W({type:t,agentId:n}){try{console.log(`\u{1F4E1} Fetching [${t}] for agent: ${n||"ALL"}`);let e;switch(t){case"system_info":e=d;break;case"installed_apps":e=v;break;case"usb_devices":e=m;break;case"port_scan":e=b;break;case"task_info":e=I;break;case"visualizer_data":e=l;break;case"agents":let r=await _.find({});return console.log(`\u2705 Found ${r.length} agents`),{success:!0,message:"Agents fetched successfully",data:r};default:return console.warn(`\u26A0 Invalid type requested: ${t}`),{success:!1,message:"Invalid data type",data:[]}}let o;if(n){console.log(`\u{1F50D} Looking for latest ${t} entry for agent ${n}...`);let r=await e.findOne({agentId:n}).sort({timestamp:-1});if(!r)return console.warn(`\u274C No ${t} data found for ${n}`),{success:!1,message:`No ${t} data found for agent ${n}`,data:[]};if(t==="task_info"){let s=await d.findOne({agentId:n}).sort({timestamp:-1});o=[{agentId:r.agentId,device:s?{hostname:s.data.hostname,os_type:s.data.os_type,os_version:s.data.os_version}:null,data:r.data,timestamp:r.timestamp}]}else o=[r]}else console.log(`\u{1F4CB} Fetching all ${t} records...`),o=await e.find({});return console.log(`\u{1F4E4} Returning ${t} data for ${n||"ALL"}`),{success:!0,message:`${t} data fetched successfully`,data:o}}catch(e){return console.error(`\u{1F525} Error fetching [${t}] for ${n}:`,e),{success:!1,message:"Internal server error while fetching data",error:e.message,data:[]}}}import De from"fs";import Ie from"path";async function J(t,n,e){if(!n||n.length===0)return[];try{let s=Ie.join(process.cwd(),"received.json");De.writeFileSync(s,JSON.stringify({agentId:t,timestamp:new Date,devices:n},null,2),"utf-8"),console.log(`[\u{1F4BE}] Received USB devices logged to: ${s}`)}catch(s){console.error("\u274C Failed to write received.json:",s)}let o=await m.findOne({agentId:t});o?o.data||(o.data={connected_devices:[]},await o.save(),console.log(`[\u2139\uFE0F] Initialized empty data object for agentId=${t}`)):(o=new m({agentId:t,data:{connected_devices:[]}}),await o.save(),console.log(`[\u{1F195}] Agent document created for agentId=${t}`));let r=[];for(let s of n){let c=s.serial_number||s.pnpid||"unknown",a=o.data.connected_devices.find(i=>i.serial_number===c);if(a)r.push({...s,status:a.status}),console.log(`[\u2139\uFE0F] USB exists: ${c} \u2192 status: ${a.status}`);else{let i={drive_letter:s.drive_letter||"",vendor_id:s.vendor_id||"",product_id:s.product_id||"",description:s.description||"",serial_number:c,status:"WaitingForApproval",last_seen:new Date};o.data.connected_devices.push(i),r.push({...s,status:"WaitingForApproval"}),console.log(`[\u{1F195}] New USB added: ${c} \u2192 status: WaitingForApproval`)}}return await o.save(),console.log("[\u2705] USB statuses updated for agent:",t),e&&e.connected&&(e.emit("usb_validation",{devices:r}),console.log("[\u{1F4E1}] USB statuses sent back to agent:",r)),r}import $e from"express";var k=$e.Router();k.get("/",async(t,n)=>{try{let e=await m.find();n.json(e)}catch(e){console.error(e),n.status(500).json({message:"Server error"})}});k.post("/status",async(t,n)=>{let{serial:e,username:o,status:r}=t.body;if(!e||!o||!r)return n.status(400).json({message:"Missing required fields"});try{let s=await m.findOne({agentId:o});if(!s)return n.status(404).json({message:"User not found"});let c=s.data.connected_devices.find(a=>a.serial_number===e);if(!c)return n.status(404).json({message:"Device not found"});c.status=r,await s.save(),n.json({message:"Status updated successfully"})}catch(s){console.error(s),n.status(500).json({message:"Internal server error"})}});var G=k;$();import Ae from"express";var C=Ae.Router();C.get("/",async(t,n)=>{try{let e=await l.find();n.json(e)}catch(e){console.error("Error fetching visualizer data:",e),n.status(500).json({error:"Internal Server Error"})}});var H=C;f();import xe from"express";var N=xe.Router();N.post("/system",async(t,n)=>{try{let e=t.body.system;if(!e)return n.status(400).json({message:"No system data provided"});let o=await d.findOne({machine_id:e.machine_id});if(o)return n.status(200).json({message:"System already exists",id:o._id});let r=new d(e);await r.save(),n.status(201).json({message:"System info saved",id:r._id})}catch(e){console.error(e),n.status(500).json({message:"Failed to save system info",error:e.message})}});N.get("/system",async(t,n)=>{try{let e=await d.find();n.status(200).json(e)}catch(e){console.error(e),n.status(500).json({message:"Failed to fetch system info",error:e.message})}});var K=N;j();import{spawn as ze}from"child_process";import M from"path";import{fileURLToPath as Re}from"url";import Te from"mongoose";import Ve from"fs";var Ee=Re(import.meta.url),O=M.dirname(Ee),Le=M.join(O,"scanner_service.py"),We=M.join(O,"../config.json");function ne(){try{return JSON.parse(Ve.readFileSync(We,"utf8")).mongo_uri||""}catch{return""}}async function Je(){let t=ne();for(;!t.startsWith("mongodb://")&&!t.startsWith("mongodb+srv://");)console.log("\u26A0\uFE0F Waiting for valid MongoDB Setup..."),await new Promise(n=>setTimeout(n,3e3)),t=ne();return console.log("\u2705 MongoDB URI detected:",t),t}async function Ge(){let t=await Je();await Te.connect(t).then(()=>console.log("\u2705 Connected to MongoDB (scanner)")).catch(n=>{console.error("\u274C MongoDB connection failed:",n.message),process.exit(1)})}async function Ce(){return console.log("\u{1F680} Starting Python scanner cycle..."),new Promise(t=>{let n=ze("python",[Le],{cwd:O,stdio:["ignore","pipe","pipe"]}),e="";n.stdout.setEncoding("utf8"),n.stdout.on("data",async o=>{if(e+=o.toString(),e.trim().endsWith("]"))try{let r=e.indexOf("["),s=e.slice(r).trim(),c=JSON.parse(s);console.log(`\u{1F4E1} Received ${c.length} devices from Python`);let a=c.map(i=>i.ips[0]);await S.deleteMany({"ips.0":{$nin:a}});for(let i of c)await S.findOneAndUpdate({"ips.0":i.ips[0]},{...i,lastSeen:new Date},{upsert:!0,new:!0});console.log(`\u2705 Synced ${c.length} devices to DB`),console.log("\u2699\uFE0F Running visualizer update after scan...");try{let{runVisualizerUpdate:i}=await Promise.resolve().then(()=>(te(),ee));await i(),console.log("\u2705 Visualizer update completed.")}catch(i){console.error("\u274C Visualizer update failed:",i.message)}e=""}catch(r){console.error("\u274C JSON parse error:",r.message),e=""}}),n.stderr.on("data",o=>{console.error("\u{1F525} Python error:",o.toString())}),n.on("close",o=>{console.log(`\u{1F501} Scanner cycle finished with code ${o}`),t()})})}async function He(){for(await Ge();;)console.log(`
\u{1F300} New scan cycle started at ${new Date().toLocaleTimeString()}`),await Ce(),console.log("\u23F3 Waiting 5 seconds before next scan..."),await new Promise(t=>setTimeout(t,5e3))}He();var Ye=re.resolve("./config.json"),h=JSON.parse(A.readFileSync(Ye,"utf8")),u=oe();u.use(Qe({origin:h.cors_origin||"*"}));u.use(oe.json());u.use("/api/visualizer-data",H);u.use("/api",K);u.get("/health",(t,n)=>n.json({status:"ok",ts:new Date().toISOString()}));u.use("/api/usb",G);var se=Ke.createServer(u),Ze=new Xe(se,{cors:{origin:h.cors_origin||"*",methods:["GET","POST"]},pingTimeout:2e4,pingInterval:5e3}),B=re.join(process.cwd(),"agent_data_log.json");Ze.on("connection",t=>{let n=t.handshake.headers["x-forwarded-for"]?.split(",")[0]||t.handshake.address||"unknown";console.log(`\u{1F50C} Agent connected: ${t.id} (${n})`),t.on("agent_data",async e=>{try{if(!e?.type||!e?.data||!e?.agentId){t.emit("agent_response",{success:!1,message:"Invalid payload format"});return}e.ip=n;try{let o=A.existsSync(B)?JSON.parse(A.readFileSync(B,"utf-8")):[];o.push({timestamp:new Date().toISOString(),payload:e}),A.writeFileSync(B,JSON.stringify(o,null,2),"utf-8")}catch(o){console.error("\u274C Failed to log agent data:",o)}if(console.log(`[\u{1F4E6}] Received ${e.type} from agent ${e.agentId} (${n})`),e.type==="usb_devices"){let o=e.data.connected_devices||[];console.log("[\u{1F539}] Connected devices received:",o);let r=await J(e.agentId,o);t.emit("usb_validation",{devices:r}),console.log("[\u2705] USB statuses sent to agent:",r);return}await T(e),t.emit("agent_response",{success:!0,message:`${e.type} saved successfully`})}catch(o){console.error("\u274C Error handling agent data:",o),t.emit("agent_response",{success:!1,message:"Failed to save agent data",error:o.message})}}),t.on("get_data",async(e,o)=>{try{let r=await W(e);o(r)}catch(r){console.error("\u274C Error fetching data:",r),o({success:!1,message:"Failed to fetch data",error:r.message,data:[]})}}),t.on("disconnect",e=>{console.log(`\u26A0\uFE0F Agent disconnected: ${t.id} (${e})`)})});async function et(){try{await P(h.mongo_uri),console.log("\u2705 MongoDB connected"),se.listen(h.socket_port||5e3,"0.0.0.0",()=>{console.log(`\u{1F680} Socket server running on port ${h.socket_port||5e3}`)})}catch(t){console.error("\u{1F4A5} Failed to start server:",t),process.exit(1)}}et();
